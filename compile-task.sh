#!/bin/bash

set -eu

if [ $# -lt 6 ]
then
    echo "Usage: benchmark-supervisor.sh dir global-dir copy-dir #cpus repo commit packages [settings..]"
    exit 1
fi

DIR=${1}; shift
GLOBALDIR=${1}; shift
COPYDIR=${1}; shift
CPUS=${1}; shift
REPO=${1}; shift
COMMIT=${1}; shift
PACKAGES=${1}; shift

trap 'rm "$GLOBALDIR"/processors/"$SLURM_JOB_ID"' EXIT

mkdir -p $DIR
mkdir -p $COPYDIR
COPYDIRBIG=$(hostname):$COPYDIR

# Pretend that we are installing in the DIR directory, but we actually do it in COPYDIR
# This is to prevent files generated by local processors to be copied to all nodes
{ time {
      bwrap --dev-bind / / --die-with-parent --bind $COPYDIR $DIR \
            build-initial-opam.sh $DIR $GLOBALDIR $COPYDIRBIG $CPUS $REPO $COMMIT $PACKAGES "$@" 2>&3
  }; } 3>&2 2> $GLOBALDIR/base-install-time.log
